<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Barrack Pivot/Atlas Quick Viewer (v3)</title>
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif;background:#0b0e14;color:#e7e7e7}
    .bar{position:sticky;top:0;display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0f1420;border-bottom:1px solid #1d263a;z-index:5}
    input{background:#0b0e14;color:#e7e7e7;border:1px solid #2a3550;border-radius:8px;padding:8px 10px;min-width:280px}
    button{background:#1a5cff;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;grid-template-columns: 360px 1fr;gap:12px;padding:12px}
    .panel{background:#0f1420;border:1px solid #1d263a;border-radius:12px;padding:10px}
    .log{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;line-height:1.35}
    canvas{background:#0b0e14;border:1px solid #1d263a;border-radius:12px;width:100%;height:calc(100vh - 92px)}
    .small{font-size:12px;opacity:.85}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    select{background:#0b0e14;color:#e7e7e7;border:1px solid #2a3550;border-radius:8px;padding:8px 10px}
  </style>
</head>
<body>
  <div class="bar">
    <div style="font-weight:700">Barrack Atlas Viewer</div>
    <span class="small">base</span>
    <input id="base" value="" />
    <button id="probe">PROBE</button>
    <button id="load" disabled>LOAD</button>
    <span id="status" class="small"></span>
  </div>

  <div class="grid">
    <div class="panel">
      <div class="small">JSON (상대/절대 URL)</div>
      <div class="row">
        <input id="u_idle" value="/asset/sprite/const/normal/barrack/barrack_idle.json" />
      </div>
      <div class="row">
        <input id="u_const" value="/asset/sprite/const/const_anim/barrack/barrack_const.json" />
      </div>
      <div class="row">
        <input id="u_dist" value="/asset/sprite/const/distruct/barrack/barrack_distruct.json" />
      </div>

      <div class="row">
        <select id="anim">
          <option value="idle">idle</option>
          <option value="const">const</option>
          <option value="dist">distruct</option>
        </select>
        <button id="play" disabled>PLAY</button>
        <button id="pause" disabled>PAUSE</button>
      </div>

      <div class="row small">
        ⚠️ 이 파일을 <b>file:///</b> 로 열면 /asset 경로는 로컬 디스크로 가서 404가 난다.<br/>
        반드시 <b>클라이언트 서버(http://localhost:PORT)</b>로 열어.
      </div>

      <hr style="border:0;border-top:1px solid #1d263a;margin:10px 0" />
      <div class="log" id="log"></div>
    </div>

    <div class="panel">
      <canvas id="cv" width="1024" height="768"></canvas>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const logEl = $("log");
const statusEl = $("status");
function log(...a){ logEl.textContent += a.join(" ") + "\n"; logEl.scrollTop = logEl.scrollHeight; }
function setStatus(s){ statusEl.textContent = s; }

function resolve(base, url){
  if (!url) return "";
  if (/^https?:\/\//i.test(url)) return url;
  if (!base) return url; // relative to current origin
  if (url.startsWith("/")) return base.replace(/\/+$/,"") + url;
  return base.replace(/\/+$/,"") + "/" + url.replace(/^\/+/,"");
}

async function probeUrl(u){
  const r = await fetch(u, {cache:"no-store"});
  const ct = (r.headers.get("content-type")||"").toLowerCase();
  return { ok:r.ok, status:r.status, ct };
}

let atlases = null;
let playing = false;
let t0 = 0;

function parseTP(json){
  // TexturePacker "multi atlas" single texture case
  const tex = json.textures?.[0];
  if (!tex) throw new Error("textures[0] missing");
  const imgName = tex.image;
  const frames = tex.frames || [];
  const map = {};
  for (const fr of frames){
    map[fr.filename] = fr;
  }
  return { image: imgName, frames, map };
}

async function loadAtlas(jsonUrl){
  const r = await fetch(jsonUrl, {cache:"no-store"});
  if(!r.ok) throw new Error(`fetch failed ${r.status} ${jsonUrl}`);
  const j = await r.json();
  const parsed = parseTP(j);

  // Load image (relative to jsonUrl directory)
  const baseDir = jsonUrl.replace(/\/[^\/]*$/,"/");
  const imgUrl = resolve("", baseDir + parsed.image);
  const img = new Image();
  img.decoding = "async";
  await new Promise((res, rej)=>{
    img.onload = ()=>res();
    img.onerror = ()=>rej(new Error("image load failed: " + imgUrl));
    img.src = imgUrl;
  });

  return { jsonUrl, imgUrl, img, map: parsed.map, list: Object.keys(parsed.map).sort() };
}

function pickList(a, prefix){
  return a.list.filter(k=>k.startsWith(prefix));
}

function numSuffix(s){
  const m = /_(\d+)\.png$/i.exec(s);
  return m?parseInt(m[1],10):NaN;
}
function sortFrames(list){
  return list.slice().sort((a,b)=>{
    const an=numSuffix(a), bn=numSuffix(b);
    if(Number.isFinite(an)&&Number.isFinite(bn)) return an-bn;
    return a.localeCompare(b);
  });
}

function drawFrame(atlas, frameName, cx, cy){
  const fr = atlas.map[frameName];
  if(!fr) return false;
  const r = fr.frame;
  const w = r.w, h = r.h;
  const ax = (fr.anchor?.x ?? 0.5), ay = (fr.anchor?.y ?? 0.5);
  const dx = Math.round(cx - w*ax), dy = Math.round(cy - h*ay);
  const ctx = $("cv").getContext("2d");
  ctx.imageSmoothingEnabled = false;
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
  ctx.drawImage(atlas.img, r.x, r.y, w, h, dx, dy, w, h);

  // crosshair & bbox
  ctx.strokeStyle = "rgba(255,255,255,.6)";
  ctx.beginPath(); ctx.moveTo(cx-12, cy); ctx.lineTo(cx+12, cy); ctx.moveTo(cx, cy-12); ctx.lineTo(cx, cy+12); ctx.stroke();
  ctx.strokeStyle = "rgba(0,255,255,.4)";
  ctx.strokeRect(dx, dy, w, h);

  ctx.fillStyle = "rgba(255,255,255,.8)";
  ctx.fillText(frameName + `  anchor(${ax.toFixed(3)},${ay.toFixed(3)})`, 12, 18);
  return true;
}

function loop(now){
  if(!playing || !atlases) return;
  const sec = (now - t0) / 1000;
  const mode = $("anim").value;
  let atlas = atlases.idle;
  let list = atlases.idleFrames;
  let fps = 6;
  if(mode==="const"){ atlas=atlases.cons; list=atlases.constFrames; fps=12; }
  if(mode==="dist"){ atlas=atlases.dist; list=atlases.distFrames; fps=12; }
  if(!list.length){ requestAnimationFrame(loop); return; }
  const idx = Math.floor(sec*fps) % list.length;
  drawFrame(atlas, list[idx], 512, 480);
  requestAnimationFrame(loop);
}

$("probe").onclick = async ()=>{
  logEl.textContent="";
  const base = $("base").value.trim();
  const uIdle = resolve(base, $("u_idle").value.trim());
  const uConst = resolve(base, $("u_const").value.trim());
  const uDist = resolve(base, $("u_dist").value.trim());
  log("[probe] idle", uIdle);
  log("[probe] const", uConst);
  log("[probe] dist", uDist);

  try{
    setStatus("probing...");
    const [a,b,c] = await Promise.all([probeUrl(uIdle), probeUrl(uConst), probeUrl(uDist)]);
    log("idle:", a.ok, a.status, a.ct);
    log("const:", b.ok, b.status, b.ct);
    log("dist:", c.ok, c.status, c.ct);
    const ok = a.ok && b.ok && c.ok;
    $("load").disabled = !ok;
    setStatus(ok ? "OK. load 눌러." : "FAIL. base/URL 다시.");
  }catch(e){
    log("probe error:", e.message);
    $("load").disabled = true;
    setStatus("FAIL");
  }
};

$("load").onclick = async ()=>{
  const base = $("base").value.trim();
  const uIdle = resolve(base, $("u_idle").value.trim());
  const uConst = resolve(base, $("u_const").value.trim());
  const uDist = resolve(base, $("u_dist").value.trim());
  try{
    setStatus("loading...");
    const [idle, cons, dist] = await Promise.all([loadAtlas(uIdle), loadAtlas(uConst), loadAtlas(uDist)]);
    const idleFrames = sortFrames(pickList(idle, "barrack_idle"));
    const constFrames = sortFrames(pickList(cons, "barrack_con_complete_"));
    const distFrames = sortFrames(pickList(dist, "barrack_distruction_"));
    atlases = { idle, cons, dist, idleFrames, constFrames, distFrames };

    log("[loaded] idle frames", idleFrames.length, "img", idle.imgUrl);
    log("[loaded] const frames", constFrames.length, "img", cons.imgUrl);
    log("[loaded] dist frames", distFrames.length, "img", dist.imgUrl);

    // draw first frame
    drawFrame(idle, idleFrames[0] || idle.list[0], 512, 480);

    $("play").disabled = false;
    $("pause").disabled = false;
    setStatus("loaded");
  }catch(e){
    log("load error:", e.message);
    setStatus("FAIL");
  }
};

$("play").onclick = ()=>{
  if(!atlases) return;
  playing = true;
  t0 = performance.now();
  requestAnimationFrame(loop);
};
$("pause").onclick = ()=>{ playing=false; };
</script>
</body>
</html>
